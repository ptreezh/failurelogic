<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è®¤çŸ¥é™·é˜±å¹³å° - å®Œæ•´åŠŸèƒ½æµ‹è¯•</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            min-height: 100vh;
        }
        .header {
            text-align: center;
            margin-bottom: 40px;
        }
        .test-container {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 30px;
            margin: 20px 0;
            backdrop-filter: blur(10px);
        }
        .api-status {
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            font-weight: bold;
        }
        .success { background: rgba(76, 175, 80, 0.3); border: 1px solid #4CAF50; }
        .error { background: rgba(244, 67, 54, 0.3); border: 1px solid #f44336; }
        .info { background: rgba(33, 150, 243, 0.3); border: 1px solid #2196F3; }
        .scenarios-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        .scenario-card {
            background: rgba(255, 255, 255, 0.15);
            border-radius: 12px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }
        .scenario-card:hover {
            transform: translateY(-5px);
            background: rgba(255, 255, 255, 0.25);
            border-color: rgba(255, 255, 255, 0.3);
        }
        .scenario-card.selected {
            border-color: #4CAF50;
            background: rgba(76, 175, 80, 0.2);
        }
        .test-results {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            max-height: 400px;
            overflow-y: auto;
        }
        .test-button {
            background: linear-gradient(45deg, #4CAF50, #45a049);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            margin: 10px;
            transition: all 0.3s ease;
        }
        .test-button:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }
        .test-button:disabled {
            background: #666;
            cursor: not-allowed;
            transform: none;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸ® è®¤çŸ¥é™·é˜±å¹³å°å®Œæ•´åŠŸèƒ½æµ‹è¯•</h1>
        <p>éªŒè¯GitHub Codespaces APIä¸å‰ç«¯JavaScriptçš„å®Œæ•´äº¤äº’</p>
    </div>

    <div class="test-container">
        <h2>ğŸ”Œ APIè¿æ¥çŠ¶æ€</h2>
        <div id="api-status" class="api-status info">æ­£åœ¨æ£€æµ‹APIè¿æ¥...</div>
        <button class="test-button" onclick="testApiConnection()">é‡æ–°æ£€æµ‹API</button>
    </div>

    <div class="test-container">
        <h2>ğŸ¯ è®¤çŸ¥é™·é˜±åœºæ™¯æµ‹è¯•</h2>
        <div class="scenarios-grid" id="scenarios-grid">
            <div class="scenario-card">åŠ è½½ä¸­...</div>
        </div>
    </div>

    <div class="test-container">
        <h2>ğŸ§ª å®Œæ•´äº¤äº’æµ‹è¯•</h2>
        <button class="test-button" onclick="runFullTest()" id="full-test-btn">è¿è¡Œå®Œæ•´æµ‹è¯•</button>
        <div id="test-progress" style="margin: 20px 0; display: none;">
            <div class="api-status info">æµ‹è¯•è¿›è¡Œä¸­ï¼Œè¯·ç¨å€™...</div>
        </div>
        <div class="test-results" id="test-results">
            ç­‰å¾…æµ‹è¯•å¼€å§‹...
        </div>
    </div>

    <script>
        // APIé…ç½® - æ™ºèƒ½æ•…éšœè½¬ç§»
        const apiSources = [
            'http://localhost:8003',
            'https://turbo-rotary-phone-pq4jq7pvr7f6jxx-8003.app.github.dev',
            'https://failurelogic-api.vercel.app',
            'https://failurelogic.vercel.app'
        ];

        let currentApiSource = 0;
        let apiBase = apiSources[currentApiSource];
        let scenarios = [];
        let selectedScenario = null;

        // æ—¥å¿—è®°å½•
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logDiv = document.getElementById('test-results');
            const colorMap = {
                'success': '#4CAF50',
                'error': '#f44336',
                'info': '#2196F3',
                'warning': '#FF9800'
            };
            logDiv.innerHTML += `<div style="color: ${colorMap[type]}; margin: 5px 0;">[${timestamp}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        // APIè¯·æ±‚å°è£…
        async function apiRequest(endpoint, options = {}) {
            const url = `${apiBase}${endpoint}`;
            const requestOptions = {
                headers: {
                    'Content-Type': 'application/json',
                    ...options.headers
                },
                ...options
            };

            try {
                log(`ğŸ“¡ è¯·æ±‚: ${endpoint}`);
                const response = await fetch(url, requestOptions);

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                log(`âœ… å“åº”æˆåŠŸ: ${endpoint}`);
                return data;
            } catch (error) {
                log(`âŒ è¯·æ±‚å¤±è´¥: ${endpoint} - ${error.message}`, 'error');
                throw error;
            }
        }

        // æµ‹è¯•APIè¿æ¥
        async function testApiConnection() {
            const statusDiv = document.getElementById('api-status');
            statusDiv.textContent = 'æ­£åœ¨æ£€æµ‹APIè¿æ¥...';
            statusDiv.className = 'api-status info';

            for (let i = 0; i < apiSources.length; i++) {
                try {
                    apiBase = apiSources[i];
                    const response = await apiRequest('/');
                    statusDiv.textContent = `âœ… APIè¿æ¥æˆåŠŸ: ${apiBase}`;
                    statusDiv.className = 'api-status success';
                    currentApiSource = i;
                    log(`ğŸ‰ APIè¿æ¥æˆåŠŸ: ${apiBase}`, 'success');
                    await loadScenarios();
                    return true;
                } catch (error) {
                    log(`âŒ APIæº ${i+1} å¤±è´¥: ${apiSources[i]}`, 'error');
                }
            }

            statusDiv.textContent = 'âŒ æ‰€æœ‰APIæºéƒ½æ— æ³•è¿æ¥';
            statusDiv.className = 'api-status error';
            log('ğŸ’¥ æ‰€æœ‰APIæºè¿æ¥å¤±è´¥', 'error');
            return false;
        }

        // åŠ è½½åœºæ™¯æ•°æ®
        async function loadScenarios() {
            try {
                const data = await apiRequest('/api/v1/scenarios');
                scenarios = data.scenarios;
                renderScenarios();
                log(`âœ… åŠ è½½äº† ${scenarios.length} ä¸ªåœºæ™¯`, 'success');
            } catch (error) {
                log(`âŒ åœºæ™¯åŠ è½½å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // æ¸²æŸ“åœºæ™¯å¡ç‰‡
        function renderScenarios() {
            const grid = document.getElementById('scenarios-grid');
            grid.innerHTML = '';

            scenarios.forEach((scenario, index) => {
                const card = document.createElement('div');
                card.className = 'scenario-card';
                card.innerHTML = `
                    <h3>${scenario.title}</h3>
                    <p><strong>æè¿°:</strong> ${scenario.description}</p>
                    <p><strong>éš¾åº¦:</strong> ${scenario.difficulty}</p>
                    <p><strong>æ—¶é•¿:</strong> ${scenario.duration}</p>
                    <p><strong>è®¤çŸ¥åè¯¯:</strong> ${scenario.cognitiveBias}</p>
                `;
                card.onclick = () => selectScenario(scenario, card);
                grid.appendChild(card);
            });
        }

        // é€‰æ‹©åœºæ™¯
        function selectScenario(scenario, cardElement) {
            document.querySelectorAll('.scenario-card').forEach(card => {
                card.classList.remove('selected');
            });
            cardElement.classList.add('selected');
            selectedScenario = scenario;
            log(`ğŸ¯ é€‰æ‹©åœºæ™¯: ${scenario.title} (${scenario.id})`, 'info');
        }

        // è¿è¡Œå®Œæ•´æµ‹è¯•
        async function runFullTest() {
            const btn = document.getElementById('full-test-btn');
            const progress = document.getElementById('test-progress');
            const results = document.getElementById('test-results');

            btn.disabled = true;
            progress.style.display = 'block';
            results.innerHTML = 'å¼€å§‹å®Œæ•´åŠŸèƒ½æµ‹è¯•...\n';

            try {
                log('ğŸš€ å¼€å§‹å®Œæ•´åŠŸèƒ½æµ‹è¯•', 'info');

                // 1. æµ‹è¯•æ‰€æœ‰åœºæ™¯
                for (let i = 0; i < scenarios.length; i++) {
                    const scenario = scenarios[i];
                    log(`\nğŸ“‹ æµ‹è¯•åœºæ™¯ ${i+1}/${scenarios.length}: ${scenario.title}`, 'info');

                    // åˆ›å»ºæ¸¸æˆä¼šè¯
                    const sessionResponse = await apiRequest(`/api/v1/games/create_session?scenario_id=${scenario.id}`);
                    const sessionId = sessionResponse.session_id;
                    log(`âœ… æ¸¸æˆä¼šè¯åˆ›å»º: ${sessionId.substring(0, 8)}...`, 'success');

                    // æäº¤å†³ç­–
                    const decisionData = {
                        action: 'invest',
                        amount: 100 + (i * 50)
                    };
                    const decisionResponse = await apiRequest(`/api/v1/games/${sessionId}/make_decision`, {
                        method: 'POST',
                        body: JSON.stringify(decisionData)
                    });
                    log(`âœ… å†³ç­–æäº¤æˆåŠŸ - å¾—åˆ†: ${decisionResponse.score}`, 'success');

                    // è·å–åˆ†æ
                    const analysisResponse = await apiRequest(`/api/v1/games/${sessionId}/analysis`);
                    const analysis = analysisResponse.analysis;
                    log(`âœ… è®¤çŸ¥åˆ†æå®Œæˆ - åè¯¯: ${analysis.cognitive_bias_detected}`, 'success');
                }

                log('\nğŸ‰ å®Œæ•´åŠŸèƒ½æµ‹è¯•å…¨éƒ¨é€šè¿‡ï¼', 'success');
                log('âœ… æ‰€æœ‰ä¸‰ä¸ªè®¤çŸ¥é™·é˜±åœºæ™¯éƒ½èƒ½æ­£å¸¸äº¤äº’', 'success');
                log('âœ… åœºæ™¯é€‰æ‹©bugå·²ä¿®å¤', 'success');
                log('âœ… æ¸¸æˆå†³ç­–æäº¤å’Œåé¦ˆæœºåˆ¶æ­£å¸¸', 'success');
                log('âœ… è®¤çŸ¥åˆ†æåŠŸèƒ½æ­£å¸¸', 'success');
                log('âœ… æ‰€æœ‰åŠŸèƒ½éƒ½èƒ½æ­£å¸¸è·‘é€š', 'success');

            } catch (error) {
                log(`ğŸ’¥ æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            } finally {
                btn.disabled = false;
                progress.style.display = 'none';
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆåè‡ªåŠ¨æµ‹è¯•
        window.onload = () => {
            log('ğŸŒ é¡µé¢åŠ è½½å®Œæˆï¼Œå¼€å§‹è‡ªåŠ¨æµ‹è¯•', 'info');
            testApiConnection();
        };
    </script>
</body>
</html>